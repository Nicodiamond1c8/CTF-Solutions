#include <stdio.h>
#include "wmmintrin.h"

unsigned char keys[10*16] = {
    0x0f,0x1f,0x84,0x00,0x00,0x00,0x00,0x00,
    0x4c,0x89,0xea,0x4c,0x89,0xf6,0x44,0x89,
    0xff,0x41,0xff,0x14,0xdc,0x48,0x83,0xc3,
    0x01,0x48,0x39,0xdd,0x75,0xea,0x48,0x83,
    0xc4,0x08,0x5b,0x5d,0x41,0x5c,0x41,0x5d,
    0x41,0x5e,0x41,0x5f,0xc3,0x90,0x66,0x2e,
    0x0f,0x1f,0x84,0x00,0x00,0x00,0x00,0x00,
    0xf3,0xc3,0x00,0x00,0x48,0x83,0xec,0x08,
    0x48,0x83,0xc4,0x08,0xc3,0x00,0x00,0x00,
    0x01,0x00,0x02,0x00,0x25,0x73,0x00,0x68,
    0x69,0x74,0x63,0x6f,0x6e,0x7b,0x25,0x73,
    0x7d,0x0a,0x00,0x00,0x01,0x1b,0x03,0x3b,
    0x40,0x00,0x00,0x00,0x07,0x00,0x00,0x00,
    0xbc,0xfd,0xff,0xff,0x8c,0x00,0x00,0x00,
    0xcc,0xfd,0xff,0xff,0xb4,0x00,0x00,0x00,
    0xec,0xfd,0xff,0xff,0x5c,0x00,0x00,0x00,
    0x1c,0xff,0xff,0xff,0xcc,0x00,0x00,0x00,
    0x57,0xff,0xff,0xff,0xec,0x00,0x00,0x00,
    0x6c,0xff,0xff,0xff,0x0c,0x01,0x00,0x00,
    0xdc,0xff,0xff,0xff,0x54,0x01,0x00,0x00};

unsigned char enc_res[16] = {0xe7, 0x47, 0x4, 0x12, 0x49, 0x6d, 0xcf, 0x47, 0xb0, 0xe9, 0x1b, 0x17, 0x67, 0xfb, 0x46, 0x28};

unsigned char xor[16] = {
        0x48, 0xc1, 0xfd, 0x03, 0xe8, 0x07, 0xfe, 0xff, 0xff, 0x48, 0x85, 0xed, 0x74, 0x20, 0x31, 0xdb
};

unsigned char start[16] = {
    0xf, 0xe, 0xd, 0xc, 0xb, 0xa, 0x9, 0x8, 0x7, 6, 5, 4, 3, 2, 1, 0};

void print128_num(__m128i var) 
{
    int64_t *v64val = (int64_t*) &var;
    printf("%.16llx%.16llx\n", v64val[1], v64val[0]);
}

int main() {
    __m128i state = *(__m128i*)&enc_res;
    state = _mm_xor_si128(state, *(__m128i*)(&keys[9*16]));
    for (int i = 8; i >= 0; i--) {
        __m128i imc = _mm_aesimc_si128(*(__m128i*)(&keys[i*16]));
        state = _mm_aesdec_si128(state, imc);
    }
    state = _mm_aesdeclast_si128(state, *(__m128i*)(&xor));

    printf("Output: ");
    print128_num(state);
}
